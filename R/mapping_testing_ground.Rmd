---
title: "Coordinate Mapping"
author: "Kim Cressman"
date: "4/28/2022"
output: 
    html_document:
        toc: true
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

Really messy script to read in a single file for each reserve and pull GPS coordinates for their stations. While I'm at it, I'll see how many have multiple values for the same station (like GND's - eek). But I'll average coordinates together for this mapping purpose.  

```{r}
library(tidyverse)
library(readxl)
library(leaflet)
```

# Setup  

## Output prep  

```{r}
all_coords <- tibble(Reserve = character(),
                     SiteID = character(),
                     Lat = numeric(),
                     Long = numeric())
```


## Helpful functions  

Because I'll be doing this repetitively on similar data files....  

```{r}
# starting path for data
path_start <- here::here("submitted_data", "data")

# figure out how many rows of headers there are
### function is modified from `check_num2` at https://stackoverflow.com/a/67532389
### to figure out which rows can't be converted to numeric
skip_fun <- function(x){
  y <- suppressWarnings(as.numeric(x))
  if(is.numeric(x)){  # if it's already a number, there was only one row of headers so that's all we need to skip (adding headers back in later)
      return(1)
      }
  max(which(is.na(y))) + 1
}

check_num2 <- function(x){
  y <- suppressWarnings(as.numeric(x))
  which(is.na(y))
}

# read in the file, figure out how much to skip, read it in again, and rename the columns from the first test file
read_cdmo <- function(file,
                      worksheet = NULL,
                      skip = NULL){
    # worksheet option if different worksheets of interest are in the file
    # skip option for reserves where the number to skip is known and the way to automate a guess *isn't* known  
    to_mod <- read_xlsx(file,
                        n_max = 10,
                        na = c("", "NA"),
                        sheet = worksheet)
    
    # which column has "Lat" in it? This should be numeric.
    lat <- str_which(names(to_mod), "Lat")
    lat_vec <- to_mod[[lat]]
    
    if(is.null(skip)){
        skip <- skip_fun(lat_vec)  
    }
    
    dat <- read_xlsx(file,
                     sheet = worksheet,
                     skip = skip,
                     col_names = FALSE) 
    names(dat) <- names(to_mod)
    dat <- dat %>% 
        mutate(SiteID = as.character(SiteID))
    return(dat)
}

# bind to `all_coords`
## don't do this twice; it doesn't check to see if these coordinates are already there
bind_coords <- function(df){
    to_bind <- df %>% 
        select(Reserve, SiteID, TransectID, PlotID, Lat, Long) %>% 
        filter(Lat != "NA") %>% 
        mutate(Lat = str_trim(Lat),
               Long = str_trim(Long),
               Lat = as.numeric(Lat),
               Long = as.numeric(Long)) %>% 
        group_by(Reserve, SiteID, TransectID, PlotID) %>% 
        summarize(Lat = round(mean(Lat, na.rm = TRUE), 5),
                  Long = round(mean(Long, na.rm = TRUE), 5)) %>% 
        ungroup() %>% 
        select(Reserve, SiteID, Lat, Long)
    all_coords <<- bind_rows(all_coords, to_bind)  
    cat(paste(nrow(to_bind), "rows have been added to `all_coords`"))
}
```



## Reserve-by-reserve  

### CDMO-formatted data  

#### APA  

```{r}
file_in <- here::here(path_start, "APA", "Data", "APAVEG2020MOD.xlsx")
apa <- read_cdmo(file_in)
bind_coords(apa)
```

#### CBM - Jug Bay  

```{r}
file_in <- here::here(path_start, "CBM", "Veg", "Jug Bay",
                      "CDMO EV Data.xlsx")
cbm_jb <- read_cdmo(file_in, worksheet = "2020") %>% 
    mutate(Long = -1 * Long)
bind_coords(cbm_jb)
```



#### CBV  

had to add "Other" as a column name in the file because there was text lower down in the column and this caused problems later.    

```{r}
file_in <- here::here(path_start, "CBV", "CBNERRVA VEG Data GI Reserve for Chris Peter.xlsx")
cbv <- read_cdmo(file_in) 
bind_coords(cbv)
```

#### JAC  

```{r}
file_in <- here::here(path_start, "JAC", "2021", "JAC 2021 Marsh Vegetation.xlsx")
jac <- read_cdmo(file_in)
bind_coords(jac)
```


#### NIW  

In this file, 'Lat' is repeated in the 'Long' column for Segment B, Plot 3-3. Removing these before binding coords because it's only one plot; will need to fix before doing other analyses.  

```{r}
file_in <- here::here(path_start, "NIW", "NIWVEG2020.xlsx")
niw <- read_cdmo(file_in) %>% 
    filter(Long < 0)
bind_coords(niw)
```


#### GTM  

```{r}
file_in <- here::here(path_start, "GTM", "GTMVEG2020.xlsx")
gtm <- read_cdmo(file_in)
bind_coords(gtm)
```

#### NOC  

Separate folders for different reserve components.  

Transects are parallel to shore rather than perpendicular.  

HAS NAs for LAT AND LONG which I was using above because other reserves didn't all have a number fo transect, plot, and/or cover. I don't know how else to make R recognize the number of header rows so I may have to just write a modified function for reserves like this.  

RC component has some leading and trailing spaces in Lat (and maybe Long) - removed spaces through the bind_coords function but check to see if it's a problem in other columns. This prevented the cells from being converted to numeric.  

```{r}
file_in <- here::here(path_start, "NOC", "Masonboro_Island_component",
                      "NOC_MI_2020.xlsx")
noc_mi <- read_cdmo(file_in, skip = 5)  # this is correct


file_in <- here::here(path_start, "NOC", "Rachel_Carson_component",
                      "NOC_RC_2019.xlsx")
noc_rc <- read_cdmo(file_in, skip = 5) # this is correct


file_in <- here::here(path_start, "NOC", "Zekes_Island_component",
                      "NOC_ZI_2019.xlsx")
noc_zi <- read_cdmo(file_in, skip = 5) # also worked correctly

bind_coords(noc_mi)
bind_coords(noc_rc)
bind_coords(noc_zi)
```


#### GND  

```{r}
file_in <- here::here(path_start, "GND", "Veg Data and Metadata",
                      "GNDVEG2020.xlsx")
gnd <- read_cdmo(file_in)
bind_coords(gnd)
```


#### MAR  

Somethings weird with these coordinates; they're not making transects when all coords for a plot are averaged together.  

```{r}
file_in <- here::here(path_start, "MAR", "Vegetation and Metadata",
                      "MARVEG2020_marsh_04.22.2021.xlsx")
mar <- read_cdmo(file_in)
bind_coords(mar)
```

#### ELK  

```{r}
file_in <- here::here(path_start, "ELK", "ELKVEG2016.FINAL.xlsx")
elk <- read_cdmo(file_in)
bind_coords(elk)
```

#### KAC  

had to add a 0 in the top QAQC column because otherwise it didn't get read in and caused problems.  

```{r}
file_in <- here::here(path_start, "KAC", "Recent data",
                      "KACVEG2021.xlsx")
kac <- read_cdmo(file_in)
bind_coords(kac)
```


#### SOS  

CDMO format, but different years in different worksheets. Will have to specify worksheet.  

Wait, they don't have lat/longs in this file! Must be in metadata somewhere. Oh, there's some in the 'Elevations' file. Not sure if PlotIDs are the same. 

```{r}
file_in <- here::here(path_start, "SOS", 
                      "SOS_PercCov_2010_2021.xlsx")

```


#### DEL  

CDMO format, but different reserve components in different worksheets. Will have to specify worksheet.  

```{r}
file_in <- here::here(path_start, "DEL", "Veg Data and Metadata",
                      "2018 DEL Veg Monitoring Raw Data.xlsx")
del_sjr <- read_cdmo(file_in, worksheet = "SJR") %>% 
    mutate(Reserve = "DEL-SJR")
del_bcr <- read_cdmo(file_in, worksheet = "BCR") %>% 
    mutate(Reserve = "DEL-BCR")
bind_coords(del_sjr)
bind_coords(del_bcr)
```


## Other long-format reserves  

HUD  

## NE project reserve packets  

GRB, NAR, WEL, WQB

### GRB  

Latitude and Longitude columns are blank; CP sent a CDMO formatted file    

```{r}
file_in <- here::here(path_start, "GRB", "GRBVEG2016.xlsx")
grb <- read_cdmo(file_in)
bind_coords(grb)
```

### NAR  

Latitude and Longitude columns are blank  

```{r}
file_in <- here::here(path_start, "NAR", "NAR Data Packet.xlsx")
```


### WEL  

lat/long columns are sparsely populated; using their 2020 CDMO-formatted file instead  

```{r}
file_in <- here::here(path_start, "WEL", "WEL Vegetation 2020 - CDMO Version.xlsx")
wel <- read_cdmo(file_in)
bind_coords(wel)
```

### WQB  

lat/long blank  

```{r}
file_in <- here::here(path_start, "WQB", "WQB Data Packet 2011-2020.xlsx")
```


## Other wide-format reserves  

ACE, CBM-OPC, CBM-MB  

### ACE  

no lat/long columns in data file - is in Elevations file  

so being wide format doesn't matter  

```{r}
file_in <- here::here(path_start, "ACE", 
                      "Plot Elevations.xlsx")
ace <- read_xlsx(file_in) %>% 
    separate(ID, into = c("Reserve", "TransectID", "PlotID"), sep = "_") %>% 
    mutate(SiteID = "EI") %>% 
    select(-'Elevation (m)')

bind_coords(ace)
```


### CBM - Otter Point Creek  

```{r}
file_in <- here::here(path_start, "CBM", "Veg", "Otter Point Creek", 
                      "MASTER_OPC_EV_Transect_Data_060512_LC.xls")

# deal with headers and reading in
cbm_prep <- read_xls(file_in, sheet = "Site Descriptions",
                    skip = 10)
names(cbm_prep)[4:5] <- c("Lat", "Long")

cbm_opc <- read_xls(file_in, sheet = "Site Descriptions",
                     skip = 12,
                     col_names = FALSE)
names(cbm_opc) <- names(cbm_prep)
rm(cbm_prep)


# deal with data frame
cbm_opc <- cbm_opc %>% 
    fill(c(Transect, 'Current Transect Name')) %>% 
    mutate(Reserve = "CBM",
           SiteID = "OPC",
           Long = Long * -1) %>% 
    filter(!is.na(Plot)) %>% 
    select(Reserve, SiteID,
           TransectID = 'Current Transect Name',
           PlotID = Plot,
           Lat, Long)

bind_coords(cbm_opc)
```


### CBM - Monie Bay  

```{r}
file_in <- here::here(path_start, "CBM", "Veg", "Monie Bay", 
                      "MASTER MBR_EV_Transect_Data_Current_2017.xlsx")


cbm_prep <- read_xlsx(file_in, sheet = "Site Description",
                    skip = 9)
names(cbm_prep)[3:4] <- c("Lat_dms", "Long_dms")

cbm_mb <- read_xlsx(file_in, sheet = "Site Description",
                     skip = 11,
                     col_names = FALSE)
names(cbm_mb) <- names(cbm_prep)
rm(cbm_prep)

cbm_mb <- cbm_mb %>% 
    fill(Transect) %>% 
    filter(!is.na(Plot)) %>% 
    mutate(Reserve = "CBM",
           SiteID = "MB") %>% 
    select(Reserve, SiteID,
           TransectID = Transect,
           PlotID = Plot,
           Lat_dms, Long_dms)

# convert gps coordinates
cbm_mb <- cbm_mb %>% 
    mutate(Lat_dms = str_replace_all(Lat_dms, "[^[:digit:][\\.]]+", " "),
           Lat_dms = str_trim(Lat_dms),
           Long_dms = str_replace_all(Long_dms, "[^[:digit:][\\.]]+", " "),
           Long_dms = str_trim(Long_dms)) %>% 
    separate(Lat_dms, into = c("Lat_deg", "Lat_min", "Lat_sec"),
             sep = " ") %>% 
    separate(Long_dms, into = c("Long_deg", "Long_min", "Long_sec"),
             sep = " ") %>% 
    mutate(across(Lat_deg:Long_sec,
                  as.numeric)) %>% 
    mutate(Lat = round(Lat_deg + (Lat_min/60) + (Lat_sec/3600), 5),
           Long = round(-1*(Long_deg + (Long_min/60) + (Long_sec/3600)), 5)) %>% 
    select(Reserve, SiteID, TransectID, PlotID, Lat, Long)

bind_coords(cbm_mb)
```


# Number plots per reserve   

See what we've got:  

```{r}
all_coords %>% 
    group_by(Reserve) %>% 
    tally() %>% 
    knitr::kable(align = "l")
```

# Map!  

```{r, fig.height = 7, fig.width = 10}
leaflet(all_coords) %>% 
    addProviderTiles(providers$Esri.WorldImagery) %>% 
    addCircles(lat = ~Lat, lng = ~Long,
               color = "orange",
               popup = ~paste(Reserve, SiteID, sep = "-")) %>% 
    addScaleBar()
```

